---
layout: post
title: 微信公众平台的坑
category: program
---


之前的两周（或者3周，加班加得有点蒙了）都在做微信公众平台。

直到昨天中午解决了最后一个BUG才敢来整理一下这几周得『收获』

#### JS-SDK

微信在6.*的某个版本把WXJSBridge换成了JS-SDK。

相比以前的那一套，JS-SDK清晰了很多，功能也变得强大了。

但是，在开发得时候能遇到的坑也变多了。

###### wx.config

新版的JS-SDK在使用之前需要先在微信服务器配置允许跨域访问的域名，配置的位置非常隐蔽而且只能配三个。

配置好跨域访问之后，在使用之前需要调用 wx.config 声明权限。调用的过程非常复杂：

- 首先需要先根据url,时间戳等等参数生成一个signature。
- 但是，生成signature的参数里有一个JSAPI_Ticket，需要向微信服务器发起请求生成。
- 这还没完，在请求JSApi_Ticket的参数里，需要带上access_token，这个token也是向微信服务器请求生成的。
- 好在 JSAPI_Ticket 和 access_token 都是可以缓存的，所以我们只有在其他页面分散的获取这些标识，以分散用户的等待时间。  

就算所有参数都是正确的，config也会有极小的几率验证失败。然后用户在使用JS-SDK操作的时候会提示授权失败。

###### API回调接口

JS-SDK的所有接口都有回调方法，大概是:```success```,```fail```,```complete```之类的。

但是，==这些回调方法是不可靠的！==

我们在项目里要用和公司Logo相配的loading效果，并且前端有防重复提交的按钮disabled效果。

我很天真的把隐藏loading和取消disabled的代码都写在fail和complete里，可是偶尔会出现没有回调的情况，导致按钮锁死。

最后被迫只能写了一个setTimeout来处理，20秒以后还是没回调就弹窗提示用户网络不稳定。

###### 图片上传接口

JS-SDK选择图片支持多张，但是上传图片不支持。

在android下支持同时发起多个请求上传，但是在ios下只能串行化的上传。

并且，==上传接口也是不可靠的！==

上传失败不一定会回调上一条说过了，但是上传不能设置超时时间，所以非常麻烦。

另外，上传媒体文件只能上传到微信服务器，所以在页面上上传之后，要把media_id(在回调里是server_id)打包丢给服务端，让服务端再发起下载媒体文件的请求来获取。

#### 服务端

###### Access_token意外失效

Access_token并不是每次都能坚持到timeout时间才失效，这么看其实还好。

###### 微信也没提供验证Access_token的接口

和上一条合并起来看就非常可怕了。

因为Access_Token每天只能调用2000次。

所以我们会在每次请求来的时候验证缓存的access_token是否超过失效时间，然后决定是申请新的token还是直接使用缓存的token。

但是，在失效时间不能完全信任的情况下，我们没有任何其他办法判断当前的token是否还能用。

最后只有在调用依赖access_token的API的时候，判断返回内容，再做异常处理。

这样的效率是非常低，而且会让用户看到微信浏览器上反复读条。

吐槽完毕

#### 完

